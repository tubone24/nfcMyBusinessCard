<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AR Experience - tubone24</title>
	<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
	<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
	<style>
		body {
			margin: 0;
			overflow: hidden;
			font-family: Arial, sans-serif;
		}

		#ar-info {
			position: fixed;
			top: 10px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 15px 30px;
			border-radius: 10px;
			z-index: 1000;
			text-align: center;
			max-width: 90%;
		}

		#ar-info h2 {
			margin: 0 0 10px 0;
			font-size: 1.2em;
		}

		#ar-info p {
			margin: 5px 0;
			font-size: 0.9em;
		}

		#back-button {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background: linear-gradient(45deg, #24E08E, #6FD740);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			font-size: 1em;
			font-weight: bold;
			cursor: pointer;
			z-index: 1000;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
		}

		#back-button:hover {
			background: linear-gradient(45deg, #1fc97b, #5cc535);
		}

		.a-loader-title {
			display: none !important;
		}
	</style>
</head>
<body>
	<div id="ar-info">
		<h2 id="status-title">â³ ã‚«ãƒ¡ãƒ©èµ·å‹•æº–å‚™ä¸­...</h2>
		<p id="status-message">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ãŠé¡˜ã„ã—ã¾ã™</p>
		<p style="font-size: 0.8em; color: #4bffde;" id="status-detail"></p>
	</div>

	<button id="back-button" onclick="window.location.href='/'">æˆ»ã‚‹</button>

	<a-scene
		id="ar-scene"
		embedded
		arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
		vr-mode-ui="enabled: false"
		renderer="logarithmicDepthBuffer: true; precision: medium;"
	>
		<!-- ã‚«ãƒ¡ãƒ© -->
		<a-entity camera></a-entity>

		<!-- ARãƒãƒ¼ã‚«ãƒ¼: pattern-marker.pattãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ -->
		<!-- å®Ÿéš›ã®ãƒãƒ¼ã‚«ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ãŸã‚‰urlã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ -->
		<a-marker type="pattern" url="/pattern-marker.patt">
			<!-- ä¾‹1: ã‚·ãƒ³ãƒ—ãƒ«ãªç®± -->
			<a-box
				position="0 0.5 0"
				rotation="0 45 0"
				color="#24E08E"
				scale="0.5 0.5 0.5"
				animation="property: rotation; to: 0 405 0; loop: true; dur: 4000; easing: linear"
			></a-box>

			<!-- ä¾‹2: çƒä½“ -->
			<a-sphere
				position="1 0.5 0"
				radius="0.3"
				color="#4bffde"
				animation="property: position; to: 1 1 0; dir: alternate; loop: true; dur: 1000; easing: easeInOutQuad"
			></a-sphere>

			<!-- ä¾‹3: å††æŸ± -->
			<a-cylinder
				position="-1 0.5 0"
				radius="0.2"
				height="1"
				color="#6FD740"
				animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear"
			></a-cylinder>

			<!-- ä¾‹4: ãƒ†ã‚­ã‚¹ãƒˆ -->
			<a-text
				value="tubone24"
				position="0 1.5 0"
				align="center"
				color="#ffffff"
				width="3"
				animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear"
			></a-text>

			<!-- ä¾‹5: 3Dãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†å ´åˆ(GLBãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ãŸã‚‰æœ‰åŠ¹åŒ–) -->
			<a-entity
				position="0 0 0"
				rotation="0 0 0"
				scale="0.5 0.5 0.5"
				gltf-model="/model.glb"
				animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear"
			></a-entity>
		</a-marker>
	</a-scene>

	<script>
		// UIè¦ç´ ã‚’å–å¾—
		const statusTitle = document.getElementById('status-title');
		const statusMessage = document.getElementById('status-message');
		const statusDetail = document.getElementById('status-detail');
		const scene = document.getElementById('ar-scene');

		// ã‚«ãƒ¡ãƒ©ã®èµ·å‹•çŠ¶æ…‹ã‚’ç›£è¦–
		let cameraStarted = false;
		let errorDetails = [];

		// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ç¢ºèª
		const protocol = window.location.protocol;
		console.log('ç¾åœ¨ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«:', protocol);
		if (protocol === 'http:' && window.location.hostname !== 'localhost') {
			errorDetails.push('âš ï¸ HTTPæ¥ç¶šã§ã™ã€‚HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚');
			if (statusDetail) {
				statusDetail.innerHTML = 'âš ï¸ <strong>HTTPæ¥ç¶šãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ</strong><br>ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™<br><br>è§£æ±ºæ–¹æ³•:<br>1. ngrokã‚’ä½¿ç”¨: <code>npx ngrok http 4321</code><br>2. ç”Ÿæˆã•ã‚ŒãŸHTTPS URLã§ã‚¢ã‚¯ã‚»ã‚¹';
			}
		}

		// getUserMediaã®ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª
		if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
			errorDetails.push('âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
			if (statusTitle) statusTitle.textContent = 'âŒ ãƒ–ãƒ©ã‚¦ã‚¶éå¯¾å¿œ';
			if (statusMessage) statusMessage.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
		} else {
			console.log('getUserMedia ã‚µãƒãƒ¼ãƒˆç¢ºèª: OK');
			errorDetails.push('âœ… getUserMedia ã‚µãƒãƒ¼ãƒˆ: OK');
		}

		// ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’æ‰‹å‹•ã§è¦æ±‚ã—ã¦ãƒ†ã‚¹ãƒˆ
		async function testCameraAccess() {
			try {
				console.log('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
				const stream = await navigator.mediaDevices.getUserMedia({
					video: { facingMode: 'environment' }
				});
				console.log('âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ!', stream);
				errorDetails.push('âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ: æˆåŠŸ');

				// ãƒ†ã‚¹ãƒˆå¾Œã™ãã«åœæ­¢
				stream.getTracks().forEach(track => track.stop());

				if (statusDetail) {
					statusDetail.innerHTML = 'âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ!<br>AR.jsã®åˆæœŸåŒ–ã‚’å¾…ã£ã¦ã„ã¾ã™...';
				}
			} catch (error) {
				console.error('âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
				errorDetails.push(`âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`);

				if (statusTitle) statusTitle.textContent = 'âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼';
				if (statusMessage) statusMessage.textContent = error.name + ': ' + error.message;

				let helpText = '';
				if (error.name === 'NotAllowedError') {
					helpText = 'ğŸ“± ã‚«ãƒ¡ãƒ©è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ<br><br>è§£æ±ºæ–¹æ³•:<br>1. ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹<br>2. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹';
				} else if (error.name === 'NotFoundError') {
					helpText = 'ğŸ“± ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br><br>ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ­è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„';
				} else if (error.name === 'NotReadableError') {
					helpText = 'ğŸ“± ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™<br><br>ä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„';
				} else if (error.name === 'OverconstrainedError') {
					helpText = 'ğŸ“± ã‚«ãƒ¡ãƒ©è¨­å®šã‚¨ãƒ©ãƒ¼<br><br>ãƒªã‚¢ã‚«ãƒ¡ãƒ©ãŒåˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
				} else {
					helpText = `ğŸ“± ã‚¨ãƒ©ãƒ¼è©³ç´°:<br>${error.name}<br>${error.message}`;
				}

				if (statusDetail) {
					statusDetail.innerHTML = helpText + '<br><br>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:<br>' + errorDetails.join('<br>');
				}
			}
		}

		// ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
		setTimeout(() => {
			testCameraAccess();
		}, 1000);

		// A-Frameã‚·ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
		if (scene) {
			scene.addEventListener('loaded', () => {
				console.log('A-Frameã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿å®Œäº†');
				errorDetails.push('âœ… A-Frameã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿å®Œäº†');
				if (statusDetail) {
					statusDetail.innerHTML = 'ã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿å®Œäº†...<br>' + errorDetails.join('<br>');
				}
			});

			// AR.jsã®åˆæœŸåŒ–å®Œäº†ã‚’æ¤œå‡º
			scene.addEventListener('arjs-video-loaded', () => {
				console.log('ã‚«ãƒ¡ãƒ©æ˜ åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ!');
				cameraStarted = true;
				if (statusTitle) statusTitle.textContent = 'ğŸ“¹ ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ!';
				if (statusMessage) statusMessage.textContent = 'ARãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„';
				if (statusDetail) statusDetail.textContent = 'ãƒãƒ¼ã‚«ãƒ¼ãŒèªè­˜ã•ã‚Œã‚‹ã¨3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
			});
		}

		// 10ç§’çµŒã£ã¦ã‚‚ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ãªã„å ´åˆã¯è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
		setTimeout(() => {
			if (!cameraStarted) {
				console.warn('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™');
				if (statusTitle) statusTitle.textContent = 'âš ï¸ ã‚«ãƒ¡ãƒ©èµ·å‹•ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™';
				if (statusMessage) statusMessage.textContent = 'ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
				if (statusDetail) {
					statusDetail.innerHTML = '<strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>' + errorDetails.join('<br>') + '<br><br>ğŸ’¡ <strong>ã‚ˆãã‚ã‚‹åŸå› :</strong><br>1. HTTPæ¥ç¶š (HTTPSå¿…é ˆ)<br>2. ã‚«ãƒ¡ãƒ©è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¦ã„ã‚‹<br>3. ä»–ã®ã‚¢ãƒ—ãƒªãŒã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ä¸­<br>4. ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„';
				}
			}
		}, 10000);

		// ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
		const marker = document.querySelector('a-marker');
		if (marker) {
			marker.addEventListener('markerFound', () => {
				console.log('ãƒãƒ¼ã‚«ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ!');
				if (statusTitle) statusTitle.textContent = 'âœ… ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºæˆåŠŸ!';
				if (statusMessage) statusMessage.textContent = '3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™';
				if (statusDetail) statusDetail.textContent = '';
			});

			marker.addEventListener('markerLost', () => {
				console.log('ãƒãƒ¼ã‚«ãƒ¼ã‚’è¦‹å¤±ã„ã¾ã—ãŸ');
				if (statusTitle) statusTitle.textContent = 'ğŸ¯ ARã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­';
				if (statusMessage) statusMessage.textContent = 'ARãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„';
				if (statusDetail) statusDetail.textContent = '';
			});
		}

		// ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
		window.addEventListener('error', (e) => {
			console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
			if (e.message && e.message.includes('getUserMedia')) {
				if (statusTitle) statusTitle.textContent = 'âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼';
				if (statusMessage) statusMessage.textContent = 'ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
				if (statusDetail) {
					statusDetail.innerHTML = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„';
				}
			}
		});
	</script>
</body>
</html>
